import os
import time
import cv2
import torch
from ultralytics import YOLO

def pick_device() -> str:
    return "cuda:0" if torch.cuda.is_available() else "cpu"

def main():
    weights = os.getenv("YOLO_WEIGHTS", "yolov8s.pt")
    conf    = float(os.getenv("CONF", "0.35"))
    iou     = float(os.getenv("IOU",  "0.60"))
    imgsz   = int(os.getenv("IMG",   "960"))
    device  = pick_device()

    model = YOLO(weights)

    results = model.predict(
        source=0,
        stream=True,
        imgsz=imgsz,
        conf=conf,
        iou=iou,
        classes=[0],
        device=device,
        verbose=False
    )

    cv2.namedWindow("YOLOv8 - Human Detection (v1.2)", cv2.WINDOW_NORMAL)

    last_t = None
    fps = 0.0

    try:
        for r in results:
            frame = r.plot()

            now = time.time()
            if last_t is not None:
                dt = max(now - last_t, 1e-6)
                inst = 1.0 / dt
                fps = 0.9 * fps + 0.1 * inst
            last_t = now

            cv2.putText(frame, f"FPS: {fps:.1f}",
                        (12, 28), cv2.FONT_HERSHEY_SIMPLEX, 0.8,
                        (255, 255, 255), 2, cv2.LINE_AA)

            cv2.imshow("YOLOv8 - Human Detection (v1.2)", frame)
            if cv2.waitKey(1) & 0xFF == 27:  # ESC to quit
                break
    finally:
        cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
